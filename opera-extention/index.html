<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>zipdn background</title>
    <script src="includes/EventEmitter.js"></script>
    <script src="includes/ev.js"></script>
    <script src="jszip/jszip.js"></script>
  </head>
  <body>
    <script type="application/javascript">
var properties={
  disabled:false,
  title:"zipdn",
  icon:"icons/icon64.png",
};
var bt=opera.contexts.toolbar.createItem(properties);
opera.contexts.toolbar.addItem(bt);
bt.addEventListener("click",function(e){
    //起動しろ!!
		var t=opera.extension.tabs.getSelected();
    if(t){
      console.log(t.readyState);
      t.postMessage("activate");
    }
});
//サーバー側
//新しいページ
opera.extension.onconnect=function(e){
  var id; //相手のid:w
  e.source.onmessage=function(e){
    if(!e.data)return;
    if(e.data.type==="myid"){
      id=e.data.id;
    }
    if(e.data==="ok"){
      //相手が起動した。こっちも起動
      opera.extension.onconnect=null;
      var event=new EventClient(e.source);
      var z=new Zipper(event);
    }
  };
};


//EventEmitterみたいな
function EventClient(source){
	this.source=source;
	var event=this.event=new EventEmitter;
	source.onmessage=function(e){
		var d=e.data;
		if(d.type==="event"){
			event.emit(d.name,d.data);
		}
	};
}
EventClient.prototype.on=function(){
	this.event.on.apply(this.event,arguments);
};
EventClient.prototype.once=function(){
	this.event.once.apply(this.event,arguments);
};
EventClient.prototype.removeListener=function(){
	this.event.removeListener.apply(this.event,arguments);
};
EventClient.prototype.emit=function(name,data){
	this.source.postMessage({
		type:"event",
		name:name,
		data:data,
	});
};
    </script>
  </body>
</html>

